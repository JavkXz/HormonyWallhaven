import { image } from '@kit.ImageKit';
import { WallpaperItem, SearchParams } from '../model/WallpaperModel';
import { WallhavenService } from '../service/WallhavenService';
import { AppConfig } from '../utils/AppConfig';

// é€‰æ‹©å™¨é€‰é¡¹æŽ¥å£
interface SelectOption {
  value: string;
  label: string;
}

// Builderå‡½æ•°å‚æ•°æŽ¥å£
interface FilterSectionParams {
  title: string;
}

interface SelectButtonGroupParams {
  options: SelectOption[];
  selected: string;
  onSelect: (value: string) => void;
}

interface WallpaperCardParams {
  wallpaper: WallpaperItem;
}

@Entry
@Component
struct Index {
  @State wallpapers: WallpaperItem[] = [];
  @State isLoading: boolean = false;
  @State isLoadingMore: boolean = false; // åŠ è½½æ›´å¤šçŠ¶æ€
  @State errorMessage: string = '';
  @State currentPage: number = 1; // å½“å‰é¡µç 
  @State hasMoreData: boolean = true; // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®

  // ç­›é€‰æ¡ä»¶çŠ¶æ€
  @State selectedCategories: number = 111; // åˆ†ç±»é€‰æ‹©ï¼š100(é€šç”¨)/110(åŠ¨æ¼«)/111(å…¨éƒ¨)
  @State isFilterExpanded: boolean = false; // ç­›é€‰é¢æ¿å±•å¼€çŠ¶æ€
  @State selectedPurity: string = '100'; // çº¯å‡€åº¦
  @State selectedSorting: string = 'date_added'; // æŽ’åºæ–¹å¼
  @State selectedOrder: string = 'desc'; // æŽ’åºé¡ºåº
  @State selectedResolution: string = ''; // åˆ†è¾¨çŽ‡

  private wallhavenService: WallhavenService = AppConfig.getInstance().getWallhavenService();

  // ç­›é€‰é€‰é¡¹æ•°ç»„
  private purityOptions: SelectOption[] = [
    { value: '100', label: 'SFW (å®‰å…¨)' },
    { value: '110', label: 'Sketchy (æˆäºº)' },
    { value: '111', label: 'å…¨éƒ¨' }
  ];

  private sortingOptions: SelectOption[] = [
    { value: 'date_added', label: 'æŒ‰æ—¥æœŸæ·»åŠ ' },
    { value: 'relevance', label: 'æŒ‰ç›¸å…³æ€§' },
    { value: 'random', label: 'éšæœº' },
    { value: 'views', label: 'æŒ‰æµè§ˆé‡' },
    { value: 'favorites', label: 'æŒ‰æ”¶è—æ•°' },
    { value: 'toplist', label: 'çƒ­é—¨æ¦œå•' }
  ];

  private orderOptions: SelectOption[] = [
    { value: 'desc', label: 'é™åº' },
    { value: 'asc', label: 'å‡åº' }
  ];

  private resolutionOptions: SelectOption[] = [
    { value: '', label: 'å…¨éƒ¨' },
    { value: '1920x1080', label: '1920x1080' },
    { value: '1920x1200', label: '1920x1200' },
    { value: '2560x1440', label: '2560x1440' },
    { value: '3840x2160', label: '4K (3840x2160)' }
  ];

  aboutToAppear() {
    console.info('[Index] é¡µé¢åŠ è½½å®Œæˆ');
    this.loadWallpapers();
  }

  // åŠ è½½å£çº¸ï¼ˆæ”¯æŒé¦–æ¬¡åŠ è½½å’ŒåŠ è½½æ›´å¤šï¼‰
  async loadWallpapers(isLoadMore: boolean = false) {
    if (this.isLoading || this.isLoadingMore) return;

    if (isLoadMore) {
      this.isLoadingMore = true;
    } else {
      this.isLoading = true;
      this.currentPage = 1;
      this.hasMoreData = true;
    }
    this.errorMessage = '';

    try {
      console.info(`[Index] å¼€å§‹åŠ è½½å£çº¸ï¼Œé¡µç : ${this.currentPage}`);

      // æž„å»ºæœç´¢å‚æ•°
      const searchParams: SearchParams = {
        purity: this.selectedPurity,
        sorting: this.selectedSorting,
        order: this.selectedOrder,
        categories: this.selectedCategories.toString(),
        page: this.currentPage
      };

      // ä»…åœ¨é€‰æ‹©åˆ†è¾¨çŽ‡æ—¶æ·»åŠ 
      if (this.selectedResolution && this.selectedResolution.length > 0) {
        (searchParams as Record<string, string>).resolutions = this.selectedResolution;
      }

      const newWallpapers = await this.wallhavenService.searchWallpapers(searchParams);
      console.info(`[Index] å£çº¸åŠ è½½å®Œæˆï¼Œæœ¬é¡µå…± ${newWallpapers.length} å¼ `);

      if (isLoadMore) {
        // åŠ è½½æ›´å¤šï¼šè¿½åŠ åˆ°çŽ°æœ‰æ•°æ®
        this.wallpapers = [...this.wallpapers, ...newWallpapers];
      } else {
        // é¦–æ¬¡åŠ è½½æˆ–åˆ·æ–°ï¼šæ›¿æ¢æ•°æ®
        this.wallpapers = newWallpapers;
      }

      // å¦‚æžœè¿”å›žçš„æ•°æ®ä¸ºç©ºæˆ–å°‘äºŽé¢„æœŸï¼Œè®¤ä¸ºæ²¡æœ‰æ›´å¤šæ•°æ®äº†
      if (newWallpapers.length === 0) {
        this.hasMoreData = false;
      }

    } catch (error) {
      console.error('[Index] åŠ è½½å£çº¸å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½å£çº¸å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥';

      if (!isLoadMore) {
        // ä½¿ç”¨å›žé€€æ•°æ®
        this.wallpapers = this.getFallbackWallpapers();
      }
    } finally {
      this.isLoading = false;
      this.isLoadingMore = false;
    }
  }

  // åŠ è½½æ›´å¤šå£çº¸
  async loadMoreWallpapers() {
    if (!this.hasMoreData || this.isLoadingMore || this.isLoading) return;

    this.currentPage++;
    console.info(`[Index] åŠ è½½æ›´å¤šï¼Œé¡µç : ${this.currentPage}`);
    await this.loadWallpapers(true);
  }

  // å›žé€€å£çº¸æ•°æ®ï¼ˆå½“APIä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
  private getFallbackWallpapers(): WallpaperItem[] {
    return [
      {
        id: 'fallback1',
        name: 'é»˜è®¤å£çº¸1',
        imageUrl: 'https://example.com/fallback1.jpg',
        width: 1920,
        height: 1080,
        aspectRatio: 1.78,
        calculatedHeight: 150
      },
      {
        id: 'fallback2',
        name: 'é»˜è®¤å£çº¸2',
        imageUrl: 'https://example.com/fallback2.jpg',
        width: 1920,
        height: 1080,
        aspectRatio: 1.78,
        calculatedHeight: 150
      }
    ];
  }

  // ç­›é€‰åŒºåŸŸç»„ä»¶
  @Builder
  FilterSection(title: string) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 8 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // é€‰æ‹©å™¨ç»„ä»¶
  @Builder
  SelectButtonGroup(options: SelectOption[], selected: string, onSelect: (value: string) => void) {
    Row({ space: 8 }) {
      ForEach(options, (option: SelectOption) => {
        Button(option.label)
          .fontSize(12)
          .height(28)
          .padding({ left: 12, right: 12 })
          .backgroundColor(selected === option.value ? '#ff2262db' : '#e0e0e0')
          .fontColor(selected === option.value ? '#ffffff' : '#666666')
          .onClick(() => {
            onSelect(option.value);
          })
      })
    }
    .width('100%')
  }

  // å£çº¸å¡ç‰‡ç»„ä»¶
  @Builder
  WallpaperCard(wallpaper: WallpaperItem) {
    Column() {
      // å›¾ç‰‡åŒºåŸŸ
      Stack() {
        Image(wallpaper.imageUrl)
          .width('100%')
          .height(wallpaper.calculatedHeight || 100)
          .objectFit(ImageFit.Fill)
          .borderRadius({ topLeft: 12, topRight: 12 })
      }
      .width('100%')

      // ä¿¡æ¯åŒºåŸŸ
      Column() {
        Row() {
          // åˆ†è¾¨çŽ‡æ ‡ç­¾
          Text(`${wallpaper.width}x${wallpaper.height}`)
            .fontSize(11)
            .fontColor('#ffffff')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('#2262db')
            .borderRadius(4)

          // çº¯å‡€åº¦æ ‡ç­¾
          Text(wallpaper.purity === 'sfw' ? 'SFW' : wallpaper.purity === 'sketchy' ? 'Sketchy' : 'NSFW')
            .fontSize(10)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor(wallpaper.purity === 'sfw' ? '#4CAF50' : wallpaper.purity === 'sketchy' ? '#FF9800' : '#F44336')
            .borderRadius(4)
            .margin({ left: 8 })

          Blank()
        }
        .width('100%')

        // æ”¶è—æ•°
        if (wallpaper.favorites && wallpaper.favorites > 0) {
          Row() {
            Blank()
            Text('â¤')
              .fontSize(10)
              .fontColor('#F44336')
            Text(`${wallpaper.favorites}`)
              .fontSize(10)
              .fontColor('#666666')
              .margin({ left: 2 })
          }
          .width('100%')
          .margin({ top: 6 })
        }
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#ffffff')
      .borderRadius({ bottomLeft: 12, bottomRight: 12 })
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 4
    })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Column() {
          Row() {
            Text('å£çº¸åº”ç”¨')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
              .backgroundColor('#ffffff')
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .alignItems(VerticalAlign.Center)
          .backgroundColor('#ffffff')

          // åŸºç¡€ç­›é€‰æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
          Row() {
            // åˆ†ç±»é€‰æ‹©
            Row({ space: 8 }) {
              Text('åˆ†ç±»:')
                .fontSize(14)
                .fontColor('#666666')

              Button('å…¨éƒ¨')
                .fontSize(12)
                .height(28)
                .padding({ left: 10, right: 10 })
                .backgroundColor(this.selectedCategories === 111 ? '#ff2262db' : '#f0f0f0')
                .fontColor(this.selectedCategories === 111 ? '#ffffff' : '#666666')
                .onClick(() => {
                  this.selectedCategories = 111;
                  this.loadWallpapers();
                })

              Button('é€šç”¨')
                .fontSize(12)
                .height(28)
                .padding({ left: 10, right: 10 })
                .backgroundColor(this.selectedCategories === 100 ? '#ff2262db' : '#f0f0f0')
                .fontColor(this.selectedCategories === 100 ? '#ffffff' : '#666666')
                .onClick(() => {
                  this.selectedCategories = 100;
                  this.loadWallpapers();
                })

              Button('åŠ¨æ¼«')
                .fontSize(12)
                .height(28)
                .padding({ left: 10, right: 10 })
                .backgroundColor(this.selectedCategories === 110 ? '#ff2262db' : '#f0f0f0')
                .fontColor(this.selectedCategories === 110 ? '#ffffff' : '#666666')
                .onClick(() => {
                  this.selectedCategories = 110;
                  this.loadWallpapers();
                })
            }
            .layoutWeight(1)

            // ä¸‹æ‹‰æŒ‰é’®
            Button(this.isFilterExpanded ? 'æ”¶èµ·ç­›é€‰ â–²' : 'æ›´å¤šç­›é€‰ â–¼')
              .fontSize(12)
              .height(28)
              .padding({ left: 12, right: 12 })
              .backgroundColor('#f0f0f0')
              .fontColor('#666666')
              .onClick(() => {
                this.isFilterExpanded = !this.isFilterExpanded;
              })
          }
          .width('100%')
          .padding({
            left: 16,
            right: 16,
            top: 8,
            bottom: 8
          })
        }
        .width('100%')
        .backgroundColor('#ffffff')

        // å±•å¼€çš„ç­›é€‰é¢æ¿
        if (this.isFilterExpanded) {
          Column() {
            // åˆ†éš”çº¿
            Divider()
              .color('#eeeeee')

            Column() {
              // æŽ’åºæ–¹å¼
              this.FilterSection('æŽ’åºæ–¹å¼')

              // æŒ‰é’®ç»„
              Row({ space: 8 }) {
                ForEach(this.sortingOptions, (option: SelectOption) => {
                  Button(option.label)
                    .fontSize(12)
                    .height(28)
                    .padding({ left: 12, right: 12 })
                    .backgroundColor(this.selectedSorting === option.value ? '#ff2262db' : '#e0e0e0')
                    .fontColor(this.selectedSorting === option.value ? '#ffffff' : '#666666')
                    .onClick(() => {
                      this.selectedSorting = option.value;
                      this.loadWallpapers();
                    })
                })
              }
              .width('100%')

              // åˆ†éš”çº¿
              Divider()
                .color('#eeeeee')
                .margin({ top: 8, bottom: 8 })

              // æŽ’åºé¡ºåº
              this.FilterSection('æŽ’åºé¡ºåº')

              // æŒ‰é’®ç»„
              Row({ space: 8 }) {
                ForEach(this.orderOptions, (option: SelectOption) => {
                  Button(option.label)
                    .fontSize(12)
                    .height(28)
                    .padding({ left: 12, right: 12 })
                    .backgroundColor(this.selectedOrder === option.value ? '#ff2262db' : '#e0e0e0')
                    .fontColor(this.selectedOrder === option.value ? '#ffffff' : '#666666')
                    .onClick(() => {
                      this.selectedOrder = option.value;
                      this.loadWallpapers();
                    })
                })
              }
              .width('100%')

              // åˆ†éš”çº¿
              Divider()
                .color('#eeeeee')
                .margin({ top: 8, bottom: 8 })

              // çº¯å‡€åº¦
              this.FilterSection('çº¯å‡€åº¦')

              // æŒ‰é’®ç»„
              Row({ space: 8 }) {
                ForEach(this.purityOptions, (option: SelectOption) => {
                  Button(option.label)
                    .fontSize(12)
                    .height(28)
                    .padding({ left: 12, right: 12 })
                    .backgroundColor(this.selectedPurity === option.value ? '#ff2262db' : '#e0e0e0')
                    .fontColor(this.selectedPurity === option.value ? '#ffffff' : '#666666')
                    .onClick(() => {
                      this.selectedPurity = option.value;
                      this.loadWallpapers();
                    })
                })
              }
              .width('100%')

              // åˆ†éš”çº¿
              Divider()
                .color('#eeeeee')
                .margin({ top: 8, bottom: 8 })

              // åˆ†è¾¨çŽ‡
              this.FilterSection('åˆ†è¾¨çŽ‡')

              // æŒ‰é’®ç»„
              Row({ space: 8 }) {
                ForEach(this.resolutionOptions, (option: SelectOption) => {
                  Button(option.label)
                    .fontSize(12)
                    .height(28)
                    .padding({ left: 12, right: 12 })
                    .backgroundColor(this.selectedResolution === option.value ? '#ff2262db' : '#e0e0e0')
                    .fontColor(this.selectedResolution === option.value ? '#ffffff' : '#666666')
                    .onClick(() => {
                      this.selectedResolution = option.value;
                      this.loadWallpapers();
                    })
                })
              }
              .width('100%')
            }
            .padding({
              left: 16,
              right: 16,
              top: 12,
              bottom: 12
            })
            .backgroundColor('#fafafa')
          }
          .width('100%')
          .backgroundColor('#ffffff')
        }

        // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        if (this.errorMessage) {
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#ff0000')
            .margin({ bottom: 10 })
            .textAlign(TextAlign.Center)
        }

        // åŠ è½½çŠ¶æ€
        if (this.isLoading) {
          Progress({ value: 0, total: 100 })
            .width(60)
            .height(60)
            .margin({ bottom: 20 })
        }

        // å£çº¸åˆ—è¡¨ï¼ˆä½¿ç”¨WaterFlowç€‘å¸ƒæµå¸ƒå±€ï¼‰
        WaterFlow({ scroller: new Scroller() }) {
          ForEach(this.wallpapers, (wallpaper: WallpaperItem) => {
            FlowItem() {
              this.WallpaperCard(wallpaper)
            }
            .width('100%')
            .height(wallpaper.calculatedHeight ? wallpaper.calculatedHeight + 70 : 170)
            .onClick(() => {
              console.info(`[Index] ç‚¹å‡»å£çº¸: ${wallpaper.id}`);
              // è¿™é‡Œå¯ä»¥æ·»åŠ å£çº¸è¯¦æƒ…é¡µé¢è·³è½¬
            })
          })

          // åŠ è½½æ›´å¤šæç¤º
          if (this.isLoadingMore) {
            FlowItem() {
              Row() {
                Progress({ value: 0, total: 100 })
                  .width(24)
                  .height(24)
                Text('åŠ è½½ä¸­...')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .height(50)
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .height(50)
          }

          if (!this.hasMoreData && this.wallpapers.length > 0) {
            FlowItem() {
              Text('æ²¡æœ‰æ›´å¤šäº†')
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .height(50)
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(50)
          }
        }
        .columnsTemplate('1fr 1fr')
        .columnsGap(8)
        .rowsGap(8)
        .width('100%')
        .layoutWeight(1)
        .padding(8)
        .onReachEnd(() => {
          console.info('[Index] æ»‘åŠ¨åˆ°åº•éƒ¨ï¼Œè§¦å‘åŠ è½½æ›´å¤š');
          this.loadMoreWallpapers();
        })
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)

      // æµ®åŠ¨åˆ·æ–°æŒ‰é’®
      Button() {
        Text('ðŸ”„')
          .fontSize(24)
      }
      .width(56)
      .height(56)
      .backgroundColor('#2262db')
      .borderRadius(28)
      .shadow({
        radius: 8,
        color: 'rgba(34, 98, 219, 0.4)',
        offsetX: 0,
        offsetY: 4
      })
      .position({ x: '100%', y: '100%' })
      .markAnchor({ x: 76, y: 76 })
      .onClick(() => {
        this.loadWallpapers(false);
      })
    }
    .width('100%')
    .height('100%')
  }}