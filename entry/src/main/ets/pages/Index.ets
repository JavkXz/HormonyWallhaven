import { image } from '@kit.ImageKit';
import { router } from '@kit.ArkUI';
import { WallpaperItem } from '../model/WallpaperModel';
import { MainViewModel } from '../viewmodel/MainViewModel';
import { AppConstants, SelectOption } from '../common/Constants';

@Entry
@Component
struct Index {
  @State viewModel: MainViewModel = new MainViewModel();

  // æœ¬åœ°ç­›é€‰çŠ¶æ€ (ç¡®ä¿ UI å“åº”æ€§)
  @State isCategoryGeneral: boolean = true;
  @State isCategoryAnime: boolean = true;
  @State isCategoryPeople: boolean = true;
  @State isPuritySFW: boolean = true;
  @State isPuritySketchy: boolean = false;
  @State isPurityNSFW: boolean = false;
  
  // æœ¬åœ°æŽ’åºçŠ¶æ€
  @State currentSorting: string = 'toplist';

  aboutToAppear() {
    console.info('[Index] é¡µé¢åŠ è½½å®Œæˆ');
    this.syncViewModelFilters();
    this.currentSorting = this.viewModel.selectedSorting;
    this.viewModel.loadWallpapers();
  }

  // åŒæ­¥çŠ¶æ€åˆ° ViewModel
  private syncViewModelFilters() {
    this.viewModel.isCategoryGeneral = this.isCategoryGeneral;
    this.viewModel.isCategoryAnime = this.isCategoryAnime;
    this.viewModel.isCategoryPeople = this.isCategoryPeople;
    this.viewModel.isPuritySFW = this.isPuritySFW;
    this.viewModel.isPuritySketchy = this.isPuritySketchy;
    this.viewModel.isPurityNSFW = this.isPurityNSFW;
    this.viewModel.selectedSorting = this.currentSorting;
  }

  // å£çº¸å¡ç‰‡ç»„ä»¶ (Material Design)
  @Builder
  WallpaperCard(wallpaper: WallpaperItem) {
    Stack({ alignContent: Alignment.Bottom }) {
      // 1. å›¾ç‰‡å±‚
      Image(wallpaper.thumbUrl)
        .width('100%')
        .aspectRatio(wallpaper.aspectRatio)
        .objectFit(ImageFit.Fill)
        .borderRadius(12)
        .backgroundColor('#f0f0f0')

      // 2. æ¸å˜é®ç½©å±‚ (æå‡æ–‡å­—å¯è¯»æ€§)
      Column()
        .width('100%')
        .height(60)
        .borderRadius({ bottomLeft: 12, bottomRight: 12 })
        .linearGradient({
          angle: 180, // ä»Žä¸Šåˆ°ä¸‹
          colors: [
            ['rgba(0,0,0,0)', 0.0],
            ['rgba(0,0,0,0.6)', 1.0]
          ]
        })
        .hitTestBehavior(HitTestMode.None) // ä¸æ‹¦æˆªç‚¹å‡»

      // 3. ä¿¡æ¯å±‚ (æµ®åŠ¨åœ¨åº•éƒ¨)
      Row() {
        // åˆ†è¾¨çŽ‡ Chip
        Text(wallpaper.resolution || `${wallpaper.width}x${wallpaper.height}`)
          .fontSize(10)
          .fontColor('rgba(255,255,255,0.9)')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('rgba(0,0,0,0.4)')
          .borderRadius(4)
          .backdropBlur(10) // æ¯›çŽ»ç’ƒèƒŒæ™¯

        Blank()

        // æ”¶è—æ•°
        if (wallpaper.favorites && wallpaper.favorites > 0) {
          Row({ space: 2 }) {
            Text('â¤')
              .fontSize(10)
              .fontColor('#FF5252') // Material Red A200
            Text(`${wallpaper.favorites}`)
              .fontSize(10)
              .fontColor('#ffffff')
          }
        }
      }
      .width('100%')
      .padding(8)

      // 4. Purity æŒ‡ç¤ºå™¨ (å³ä¸Šè§’)
      if (wallpaper.purity) {
        Circle({ width: 8, height: 8 })
          .fill(wallpaper.purity === 'sfw' ? '#4CAF50' : wallpaper.purity === 'sketchy' ? '#FFC107' : '#F44336')
          .position({ x: '100%', y: 0 })
          .markAnchor({ x: 16, y: -8 }) // å³ä¸Šè§’åç§»
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.3)' })
      }
    }
    .width('100%')
  }

  build() {
    Stack() {
      Column() {
        // 1. é¡¶éƒ¨ Header
        Row() {
          Text('Wallhaven')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Blank()
          Button({ type: ButtonType.Circle }) {
            Text('ðŸ”').fontSize(16)
          }
          .width(36)
          .height(36)
          .backgroundColor('#f5f5f5')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })

        // 2. ç­›é€‰æ  (æ¨ªå‘æ»šåŠ¨ - ä»…ä¿ç•™ Categories)
        Column() {
          Scroll() {
            Row() {
              // Categories Group
              Row() {
                FilterChip({
                  label: 'General',
                  isSelected: this.isCategoryGeneral,
                  onClickAction: () => {
                    this.isCategoryGeneral = !this.isCategoryGeneral;
                    this.syncViewModelFilters();
                    this.viewModel.loadWallpapers();
                  }
                })
                FilterChip({
                  label: 'Anime',
                  isSelected: this.isCategoryAnime,
                  onClickAction: () => {
                    this.isCategoryAnime = !this.isCategoryAnime;
                    this.syncViewModelFilters();
                    this.viewModel.loadWallpapers();
                  }
                })
                FilterChip({
                  label: 'People',
                  isSelected: this.isCategoryPeople,
                  onClickAction: () => {
                    this.isCategoryPeople = !this.isCategoryPeople;
                    this.syncViewModelFilters();
                    this.viewModel.loadWallpapers();
                  }
                })
              }
            }
            .padding({ left: 16, right: 16 })
          }
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .width('100%')
          .height(40)
          .align(Alignment.Start)

          // 3. é«˜çº§ç­›é€‰å±•å¼€æŒ‰é’® & çŠ¶æ€æ˜¾ç¤º
          Row() {
            // å½“å‰æŽ’åºçŠ¶æ€ç®€ç•¥æ˜¾ç¤º
            Text(`Sorted by: ${this.currentSorting}`)
              .fontSize(12)
              .fontColor('#999999')
            
            Blank()

            Row() {
              Text(this.viewModel.isFilterExpanded ? 'Hide Filters' : 'More Filters')
                .fontSize(12)
                .fontColor('#2262db')
              Text(this.viewModel.isFilterExpanded ? ' â–²' : ' â–¼')
                .fontSize(10)
                .fontColor('#2262db')
            }
            .onClick(() => {
              this.viewModel.isFilterExpanded = !this.viewModel.isFilterExpanded;
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })

          // 4. å±•å¼€çš„ç­›é€‰é¢æ¿ (åŒ…å« Sorting, Purity, TopRange, Resolution)
          if (this.viewModel.isFilterExpanded) {
            Column() {
              Divider().color('#f0f0f0')

              // Sorting (ç§»å›žè¿™é‡Œ)
              Text('Sorting').fontSize(12).fontColor('#999').margin({ top: 12, bottom: 8, left: 16 })
              Scroll() {
                Row() {
                  ForEach(AppConstants.SORTING_OPTIONS, (option: SelectOption) => {
                    SelectChip({
                      label: option.label,
                      value: option.value,
                      currentValue: this.currentSorting,
                      onSelectAction: () => {
                        this.currentSorting = option.value;
                        this.syncViewModelFilters();
                        this.viewModel.loadWallpapers();
                      }
                    })
                  })
                }
                .padding({ left: 16, right: 16 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .scrollBar(BarState.Off)
              .width('100%')
              .height(40)
              
              // Purity
              Text('Purity').fontSize(12).fontColor('#999').margin({ top: 12, bottom: 8, left: 16 })
              Scroll() {
                Row() {
                  FilterChip({
                    label: 'SFW',
                    isSelected: this.isPuritySFW,
                    onClickAction: () => {
                      this.isPuritySFW = !this.isPuritySFW;
                      this.syncViewModelFilters();
                      this.viewModel.loadWallpapers();
                    }
                  })
                  FilterChip({
                    label: 'Sketchy',
                    isSelected: this.isPuritySketchy,
                    onClickAction: () => {
                      this.isPuritySketchy = !this.isPuritySketchy;
                      this.syncViewModelFilters();
                      this.viewModel.loadWallpapers();
                    }
                  })
                }
                .padding({ left: 16, right: 16 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .scrollBar(BarState.Off)
              .width('100%')
              .height(40)

              // TopRange (ä»…å½“ Sorting == toplist æ—¶æ˜¾ç¤º)
              if (this.currentSorting === 'toplist') {
                Text('Time Range').fontSize(12).fontColor('#999').margin({ top: 12, bottom: 8, left: 16 })
                Scroll() {
                  Row() {
                    ForEach(AppConstants.TOPRANGE_OPTIONS, (option: SelectOption) => {
                      SelectChip({
                        label: option.label,
                        value: option.value,
                        currentValue: this.viewModel.selectedTopRange,
                        onSelectAction: () => {
                          this.viewModel.selectedTopRange = option.value;
                          this.viewModel.loadWallpapers();
                        }
                      })
                    })
                  }
                  .padding({ left: 16, right: 16 })
                }
                .scrollable(ScrollDirection.Horizontal)
                .scrollBar(BarState.Off)
                .width('100%')
                .height(40)
              }

              // Resolution
              Text('Resolution').fontSize(12).fontColor('#999').margin({ top: 12, bottom: 8, left: 16 })
               Scroll() {
                Row() {
                    ForEach(AppConstants.RESOLUTION_OPTIONS, (option: SelectOption) => {
                      SelectChip({
                        label: option.label,
                        value: option.value,
                        currentValue: this.viewModel.selectedResolution,
                        onSelectAction: () => {
                          this.viewModel.selectedResolution = option.value;
                          this.viewModel.loadWallpapers();
                        }
                      })
                    })
                  }
                  .padding({ left: 16, right: 16 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .scrollBar(BarState.Off)
              .width('100%')
              .height(40)

              // åº•éƒ¨ç•™ç™½
              Blank().height(16)
            }
            .width('100%')
            .backgroundColor('#fafafa')
            .animation({ duration: 300 })
          }
        }
        .width('100%')
        .backgroundColor('#ffffff')
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        .zIndex(1) // ç¡®ä¿åœ¨ WaterFlow ä¸Šæ–¹

        // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        if (this.viewModel.errorMessage) {
          Text(this.viewModel.errorMessage)
            .fontSize(14)
            .fontColor('#ff0000')
            .margin({ top: 10, bottom: 10 })
            .textAlign(TextAlign.Center)
        }

        // åŠ è½½çŠ¶æ€ (åˆæ¬¡åŠ è½½)
        if (this.viewModel.isLoading) {
          Column() {
            Progress({ value: 0, total: 100, type: ProgressType.ScaleRing })
              .width(50)
              .height(50)
              .color('#2262db')
            Text('Loading awesome wallpapers...')
              .fontSize(12)
              .fontColor('#999')
              .margin({ top: 16 })
          }
          .width('100%')
          .height('50%')
          .justifyContent(FlexAlign.Center)
        }

        // å£çº¸åˆ—è¡¨
        WaterFlow({ scroller: new Scroller() }) {
          LazyForEach(this.viewModel.dataSource, (wallpaper: WallpaperItem) => {
            FlowItem() {
              this.WallpaperCard(wallpaper)
            }
            .width('100%')
            // ç§»é™¤å›ºå®šé«˜åº¦ï¼Œè®©å†…å®¹æ ¹æ® aspectRatio è‡ªé€‚åº”
            .onClick(() => {
              console.info(`[Index] ç‚¹å‡»å£çº¸: ${wallpaper.id}`);
              router.pushUrl({
                url: 'pages/WallpaperDetail',
                params: {
                  wallpaper: wallpaper
                }
              });
            })
          }, (item: WallpaperItem) => item.id) // ä½¿ç”¨ ID ä½œä¸º Key

          // åŠ è½½æ›´å¤šæç¤º
          if (this.viewModel.isLoadingMore) {
            FlowItem() {
              Row() {
                Progress({ value: 0, total: 100 })
                  .width(24)
                  .height(24)
                Text('åŠ è½½ä¸­...')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .height(50)
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .height(50)
          }

          if (!this.viewModel.hasMoreData && this.viewModel.dataSource.totalCount() > 0) {
            FlowItem() {
              Text('æ²¡æœ‰æ›´å¤šäº†')
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .height(50)
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(50)
          }
        }
        .columnsTemplate('1fr 1fr')
        .columnsGap(8)
        .rowsGap(8)
        .width('100%')
        .layoutWeight(1)
        .padding(8)
        .onReachEnd(() => {
          console.info('[Index] æ»‘åŠ¨åˆ°åº•éƒ¨ï¼Œè§¦å‘åŠ è½½æ›´å¤š');
          this.viewModel.loadMore();
        })
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)

      // æµ®åŠ¨åˆ·æ–°æŒ‰é’®
      Button() {
        Text('ðŸ”„')
          .fontSize(24)
      }
      .width(56)
      .height(56)
      .backgroundColor('#2262db')
      .borderRadius(28)
      .shadow({
        radius: 8,
        color: 'rgba(34, 98, 219, 0.4)',
        offsetX: 0,
        offsetY: 4
      })
      .position({ x: '100%', y: '100%' })
      .markAnchor({ x: 76, y: 76 })
      .onClick(() => {
        this.viewModel.loadWallpapers(false);
      })
    }
    .width('100%')
    .height('100%')
  }
}

// ----------------------------------------
// å¤–éƒ¨è‡ªå®šä¹‰ç»„ä»¶ (è§£å†³çŠ¶æ€åˆ·æ–°é—®é¢˜)
// ----------------------------------------

@Component
struct FilterChip {
  @Prop label: string;
  @Prop isSelected: boolean;
  onClickAction: () => void = () => {};

  build() {
    Text(this.label)
      .fontSize(12)
      .fontColor(this.isSelected ? '#ffffff' : '#666666')
      .padding({ left: 16, right: 16, top: 6, bottom: 6 })
      .backgroundColor(this.isSelected ? '#2262db' : '#f0f0f0')
      .borderRadius(16)
      .margin({ right: 8 })
      .onClick(() => {
        if (this.onClickAction) {
          this.onClickAction();
        }
      })
      .animation({ duration: 200 })
  }
}

@Component
struct SelectChip {
  @Prop label: string;
  @Prop value: string;
  @Prop currentValue: string;
  onSelectAction: () => void = () => {};

  build() {
    Text(this.label)
      .fontSize(12)
      .fontColor(this.currentValue === this.value ? '#ffffff' : '#666666')
      .padding({ left: 16, right: 16, top: 6, bottom: 6 })
      .backgroundColor(this.currentValue === this.value ? '#2262db' : '#f0f0f0') // ç»Ÿä¸€ä½¿ç”¨ä¸»é¢˜è“
      .borderRadius(16)
      .margin({ right: 8 })
      .onClick(() => {
        if (this.onSelectAction) {
          this.onSelectAction();
        }
      })
      .animation({ duration: 200 })
  }
}